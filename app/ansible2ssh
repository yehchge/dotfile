#!/bin/bash
# ansible2ssh - å°‡ Ansible inventory è½‰æˆ ~/.ssh/config

INVENTORY=${1:-hosts.yml}    # é è¨­è®€å–ç•¶å‰ç›®éŒ„çš„ inventory.ini
CONFIG="$HOME/.ssh/config"

if ! command -v ansible-inventory >/dev/null 2>&1; then
    echo "âŒ æœªå®‰è£ ansibleï¼Œè«‹å…ˆåŸ·è¡Œï¼šsudo apt install ansible -y"
    exit 1
fi

if [ ! -f "$INVENTORY" ]; then
    echo "âŒ æ‰¾ä¸åˆ° $INVENTORY"
    exit 1
fi

echo "ðŸ”„ è®€å– $INVENTORYï¼Œæ›´æ–° $CONFIG ..."

# å…ˆå‚™ä»½èˆŠæª”
cp "$CONFIG" "$CONFIG.bak.$(date +%Y%m%d%H%M%S)" 2>/dev/null

# å°‡ ansible inventory è½‰æˆ JSONï¼Œå†æŠ“å‡º host è³‡è¨Š
ansible-inventory -i "$INVENTORY" --list --yaml | \
grep -E '^[a-zA-Z0-9_.-]+:' | \
sed 's/://g' | while read -r HOST; do
    # å¾ž ansible-inventory å–è®Šæ•¸
    HOSTNAME=$(ansible-inventory -i "$INVENTORY" --host "$HOST" | grep ansible_host | awk '{print $2}')
    USER=$(ansible-inventory -i "$INVENTORY" --host "$HOST" | grep ansible_user | awk '{print $2}')
    PORT=$(ansible-inventory -i "$INVENTORY" --host "$HOST" | grep ansible_port | awk '{print $2}')
    [ -z "$PORT" ] && PORT=22

    # å¯«å…¥ ~/.ssh/config
    cat >>"$CONFIG" <<EOF

Host $HOST
    HostName $HOSTNAME
    User ${USER:-$USER}
    Port $PORT
EOF
done

echo "âœ… å·²æ›´æ–° $CONFIG"
echo "ðŸ’¡ ç¾åœ¨å¯ä»¥ç›´æŽ¥ç”¨ï¼šssh <host> é€£ç·š"

